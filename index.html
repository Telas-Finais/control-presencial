<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Presencial V30 - Password Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .status {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .status h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }
        
        .status-ok {
            color: #10b981;
            font-weight: bold;
        }
        
        .status-error {
            color: #ef4444;
            font-weight: bold;
        }
        
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
        }
        
        .log {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log div {
            margin: 5px 0;
        }
        
        .log .error {
            color: #ef4444;
        }
        
        .log .success {
            color: #10b981;
        }
        
        .log .info {
            color: #3b82f6;
        }
        
        .version {
            text-align: center;
            color: #94a3b8;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Control Presencial V30</h1>
        
        <div class="status">
            <h3>üìä Estado del Sistema</h3>
            <div class="status-item">
                <span>Conexi√≥n Supabase:</span>
                <span id="status-connection" class="status-error">‚è≥ Verificando...</span>
            </div>
            <div class="status-item">
                <span>SELECT (lectura):</span>
                <span id="status-select" class="status-error">‚è≥ Esperando...</span>
            </div>
            <div class="status-item">
                <span>INSERT (escritura):</span>
                <span id="status-insert" class="status-error">‚è≥ Esperando...</span>
            </div>
        </div>
        
        <button class="btn-primary" onclick="testConnection()">
            1Ô∏è‚É£ Verificar Conexi√≥n
        </button>
        
        <button class="btn-success" onclick="testSelect()">
            2Ô∏è‚É£ Test SELECT (lectura)
        </button>
        
        <button class="btn-warning" onclick="testInsert()">
            3Ô∏è‚É£ Test INSERT (escritura)
        </button>
        
        <div id="log" class="log"></div>
        
        <div class="version">
            v30 - PASSWORD FIXED | Clean Schema | Ready for GPS
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURACI√ìN SUPABASE
        // ========================================
        const SUPABASE_URL = 'https://tpgeypsklfihdbdnzlcc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwZ2V5cHNrbGZpaGRiZG56bGNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzU1MTEsImV4cCI6MjA4MDk1MTUxMX0.fdjbMgVEgyCGXCUJFz6wWuzyS_mfBsFLWmBwEfh1UM4';

        // ========================================
        // CLIENTE SUPABASE DIRECTO (API REST)
        // ========================================
        const supabase = {
            url: SUPABASE_URL,
            key: SUPABASE_KEY,
            
            // SELECT - Lectura de datos
            async select(table, query = '*') {
                try {
                    const url = `${this.url}/rest/v1/${table}?select=${query}`;
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': this.key,
                            'Authorization': `Bearer ${this.key}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    return { data, error: null };
                } catch (error) {
                    return { data: null, error };
                }
            },
            
            // INSERT - Escritura de datos
            async insert(table, records) {
                try {
                    const url = `${this.url}/rest/v1/${table}`;
                    const body = Array.isArray(records) ? records : [records];
                    
                    log(`üì§ Enviando a ${table}:`, 'info');
                    log(JSON.stringify(body, null, 2), 'info');
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'apikey': this.key,
                            'Authorization': `Bearer ${this.key}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(body)
                    });
                    
                    const responseText = await response.text();
                    
                    log(`üì• Response status: ${response.status}`, response.ok ? 'success' : 'error');
                    log(`üì• Response body: ${responseText}`, response.ok ? 'success' : 'error');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${responseText}`);
                    }
                    
                    const data = JSON.parse(responseText);
                    return { data, error: null };
                } catch (error) {
                    return { data: null, error };
                }
            },
            
            // UPDATE - Actualizaci√≥n de datos
            async update(table, id, updates) {
                try {
                    const url = `${this.url}/rest/v1/${table}?id=eq.${id}`;
                    const response = await fetch(url, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.key,
                            'Authorization': `Bearer ${this.key}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    return { data, error: null };
                } catch (error) {
                    return { data: null, error };
                }
            },
            
            // DELETE - Eliminaci√≥n de datos
            async delete(table, id) {
                try {
                    const url = `${this.url}/rest/v1/${table}?id=eq.${id}`;
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'apikey': this.key,
                            'Authorization': `Bearer ${this.key}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    return { data: null, error: null };
                } catch (error) {
                    return { data: null, error };
                }
            }
        };

        // ========================================
        // SISTEMA DE LOG
        // ========================================
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('es-ES');
            const className = type;
            
            const logEntry = document.createElement('div');
            logEntry.className = className;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(element, status, text) {
            const el = document.getElementById(element);
            el.className = status === 'ok' ? 'status-ok' : 'status-error';
            el.textContent = text;
        }

        // ========================================
        // TESTS
        // ========================================
        
        async function testConnection() {
            clearLog();
            log('üîå Iniciando test de conexi√≥n...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    headers: {
                        'apikey': SUPABASE_KEY
                    }
                });
                
                if (response.ok || response.status === 404) {
                    log('‚úÖ Conexi√≥n exitosa a Supabase!', 'success');
                    updateStatus('status-connection', 'ok', '‚úÖ Conectado');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                updateStatus('status-connection', 'error', '‚ùå Error');
            }
        }
        
        async function testSelect() {
            clearLog();
            log('üìñ Iniciando test SELECT...', 'info');
            
            try {
                const result = await supabase.select('workers');
                
                if (result.error) {
                    throw result.error;
                }
                
                log(`‚úÖ SELECT exitoso!`, 'success');
                log(`üìä Registros encontrados: ${result.data.length}`, 'success');
                
                if (result.data.length > 0) {
                    log('üìã Muestra del primer registro:', 'info');
                    log(JSON.stringify(result.data[0], null, 2), 'info');
                }
                
                updateStatus('status-select', 'ok', '‚úÖ Funcionando');
            } catch (error) {
                log(`‚ùå Error en SELECT: ${error.message}`, 'error');
                updateStatus('status-select', 'error', '‚ùå Error');
            }
        }
        
        async function testInsert() {
            clearLog();
            log('‚úçÔ∏è Iniciando test INSERT...', 'info');
            
            try {
                const timestamp = Date.now();
                
                const testWorker = {
                    nombre: `Test Worker ${timestamp}`,
                    usuario: `test_${timestamp}`,
                    password: 'test123',  // ‚Üê SIN √ë (corregido)
                    role: 'worker',
                    obra_asig: 'FONTOURA'
                };
                
                log('üìù Datos a insertar:', 'info');
                log(JSON.stringify(testWorker, null, 2), 'info');
                
                const result = await supabase.insert('workers', testWorker);
                
                if (result.error) {
                    throw result.error;
                }
                
                log('', 'success');
                log('üéâüéâüéâ ¬°¬°¬°INSERT EXITOSO!!! üéâüéâüéâ', 'success');
                log('', 'success');
                log('üìä Datos insertados correctamente:', 'success');
                log(JSON.stringify(result.data[0], null, 2), 'success');
                
                updateStatus('status-insert', 'ok', '‚úÖ Funcionando');
                
                log('', 'info');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
                log('üöÄ SISTEMA 100% FUNCIONAL', 'success');
                log('üéØ LISTO PARA IMPLEMENTAR GPS', 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
                
            } catch (error) {
                log(`‚ùå Error en INSERT: ${error.message}`, 'error');
                updateStatus('status-insert', 'error', '‚ùå Error');
            }
        }

        // ========================================
        // EXPONER AL GLOBAL PARA DEBUG
        // ========================================
        window.supabase = supabase;
        window.testConnection = testConnection;
        window.testSelect = testSelect;
        window.testInsert = testInsert;

        // ========================================
        // AUTO-TEST AL CARGAR
        // ========================================
        window.addEventListener('load', () => {
            log('üéØ Sistema V30 cargado - Password field fixed', 'success');
            log('üëâ Presiona "1Ô∏è‚É£ Verificar Conexi√≥n" para empezar', 'info');
        });
    </script>
</body>
</html>
